<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLAM Auction - Full Interactive</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { margin: 0; font-family: 'DM Sans', -apple-system, sans-serif; }
        #root { min-height: 100vh; }
        
        /* Mobile responsive container */
        .main-container {
          max-width: 1200px;
          margin: 0 auto;
          padding: 0 16px;
        }
        
        @media (max-width: 768px) {
          .main-container {
            padding: 0 12px;
          }
          
          /* Stack grid on mobile */
          .two-column-grid {
            display: flex !important;
            flex-direction: column !important;
            gap: 16px !important;
          }
          
          /* Smaller header on mobile */
          .header-row {
            flex-direction: column !important;
            align-items: flex-start !important;
            gap: 12px !important;
          }
          
          .header-title {
            font-size: 20px !important;
          }
          
          /* Bid buttons grid */
          .bid-grid {
            grid-template-columns: repeat(4, 1fr) !important;
          }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const formatBid = (bid) => {
          if (bid === 'Pass') return 'Pass';
          if (bid === 'X') return 'X';
          const suits = { C: '‚ô£', D: '‚ô¶', H: '‚ô•', S: '‚ô†' };
          const level = bid.charAt(0);
          const suit = bid.substring(1);
          return suit === 'NT' ? level+'NT' : level+suits[suit];
        };

        const getNextSeat = (seat) => {
          const seats = ['N', 'E', 'S', 'W'];
          return seats[(seats.indexOf(seat) + 1) % 4];
        };

        // Scenarios with ALL 4 hands for full auction
        const SCENARIOS = [
          {
            id: "U01", module: "BASIC", title: "Responding to 1NT",
            dealer: "N", vul: "None", your_seat: "S",
            hands: {
              N: { S: "A105", H: "KQ84", D: "AQ6", C: "K73" },
              E: { S: "9632", H: "J105", D: "10984", C: "Q4" },
              S: { S: "KJ84", H: "A963", D: "K72", C: "85" },
              W: { S: "Q7", H: "72", D: "J53", C: "AJ10962" }
            },
            opening_bid: "1NT",
            correct_first_bid: "2C",
            alternatives: [],
            conventions: ["stayman"],
            teaching_point: "Use Stayman (2‚ô£) to find 4-4 major fit",
            optimal_contract: "4H by N"
          },
          {
            id: "U02", module: "BASIC", title: "Partner Opens 1NT",
            dealer: "N", vul: "None", your_seat: "S",
            hands: {
              N: { S: "A105", H: "KQ84", D: "AQ6", C: "K73" },
              E: { S: "632", H: "J1052", D: "J984", C: "Q4" },
              S: { S: "Q109764", H: "K5", D: "Q83", C: "72" },
              W: { S: "KJ8", H: "A73", D: "K1075", C: "AJ10" }
            },
            opening_bid: "1NT",
            correct_first_bid: "2H",
            alternatives: [],
            conventions: ["transfers"],
            teaching_point: "Transfer to spades with 2‚ô•",
            optimal_contract: "2S by N"
          },
          {
            id: "U03", module: "BASIC", title: "Partner Opens 1‚ô†",
            dealer: "N", vul: "None", your_seat: "S",
            hands: {
              N: { S: "AKJ84", H: "K6", D: "A84", C: "Q73" },
              E: { S: "632", H: "J1052", D: "J109", C: "854" },
              S: { S: "Q5", H: "A983", D: "KQ62", C: "AK2" },
              W: { S: "1097", H: "Q74", D: "753", C: "J1096" }
            },
            opening_bid: "1S",
            correct_first_bid: "2D",
            alternatives: [],
            conventions: [],
            teaching_point: "Bid 2‚ô¶ to establish game force",
            optimal_contract: "6S by N"
          },
          {
            id: "U04", module: "BASIC", title: "Partner Preempts 2‚ô†",
            dealer: "N", vul: "None", your_seat: "S",
            hands: {
              N: { S: "KQ10865", H: "74", D: "J82", C: "93" },
              E: { S: "J9", H: "J1052", D: "Q1094", C: "Q85" },
              S: { S: "A874", H: "A96", D: "AK62", C: "AK" },
              W: { S: "32", H: "KQ83", D: "753", C: "J10764" }
            },
            opening_bid: "2S",
            correct_first_bid: "4S",
            alternatives: ["6S"],
            teaching_point: "Jump to game with 20+ HCP after weak 2",
            optimal_contract: "4S by N"
          },
          {
            id: "U05", module: "BASIC", title: "Invitational Hand With Support",
            dealer: "S", vul: "None", your_seat: "N",
            hands: {
              N: { S: "K84", H: "AJ63", D: "Q72", C: "K85" },
              E: { S: "J1096", H: "Q75", D: "J104", C: "Q32" },
              S: { S: "AQ732", H: "K4", D: "AK5", C: "J64" },
              W: { S: "5", H: "10982", D: "9863", C: "A1097" }
            },
            opening_bid: "1S",
            correct_first_bid: "3S",
            alternatives: [],
            teaching_point: "Invite game with 10-12 HCP and 4-card support",
            optimal_contract: "4S by S"
          },
          {
            id: "C01", module: "COMPETE", title: "Partner Opens, RHO Overcalls",
            dealer: "W", vul: "None", your_seat: "S",
            hands: {
              N: { S: "AQ1084", H: "K6", D: "A73", C: "K52" },
              E: { S: "73", H: "QJ10984", D: "95", C: "J64" },
              S: { S: "J65", H: "A832", D: "KQ62", C: "A2" },
              W: { S: "K92", H: "75", D: "J1084", C: "Q10987" }
            },
            opening_bid: "1S",
            correct_first_bid: "X",
            alternatives: [],
            teaching_point: "Negative double shows 4+ in unbid major",
            optimal_contract: "4S by N"
          },
          {
            id: "C02", module: "COMPETE", title: "RHO Opens 1‚ô•",
            dealer: "E", vul: "E/W", your_seat: "S",
            hands: {
              N: { S: "A2", H: "K64", D: "A10832", C: "Q73" },
              E: { S: "K93", H: "KQJ95", D: "K4", C: "A84" },
              S: { S: "Q10765", H: "A10832", D: "6", C: "K2" },
              W: { S: "J84", H: "7", D: "QJ975", C: "J10965" }
            },
            opening_bid: "1H",
            correct_first_bid: "2H",
            alternatives: [],
            teaching_point: "Michaels cue bid shows 5-5 in majors",
            optimal_contract: "4S by S"
          },
          {
            id: "C03", module: "COMPETE", title: "After They Open 1‚ô•",
            dealer: "S", vul: "None", your_seat: "W",
            hands: {
              N: { S: "AQ64", H: "AK83", D: "A6", C: "K83" },
              E: { S: "KJ1083", H: "QJ104", D: "84", C: "A5" },
              S: { S: "952", H: "965", D: "QJ2", C: "Q742" },
              W: { S: "7", H: "72", D: "KQ10953", C: "J10964" }
            },
            opening_bid: "1S",
            correct_first_bid: "2NT",
            alternatives: [],
            teaching_point: "Unusual 2NT shows both minors",
            optimal_contract: "5D by W"
          },
          {
            id: "C04", module: "COMPETE", title: "Supporting Partner's Overcall",
            dealer: "W", vul: "None", your_seat: "S",
            hands: {
              N: { S: "AK985", H: "64", D: "K73", C: "J52" },
              E: { S: "432", H: "J1085", D: "Q652", C: "93" },
              S: { S: "Q1096", H: "K3", D: "AJ84", C: "A72" },
              W: { S: "J7", H: "AQ972", D: "109", C: "KQ1084" }
            },
            opening_bid: "1H",
            correct_first_bid: "2H",
            alternatives: [],
            teaching_point: "Cue opponent's suit for game-forcing raise",
            optimal_contract: "4S by N"
          },
          {
            id: "C05", module: "COMPETE", title: "Raising After Overcall",
            dealer: "N", vul: "N/S", your_seat: "S",
            hands: {
              N: { S: "AKJ84", H: "K6", D: "Q73", C: "A52" },
              E: { S: "32", H: "QJ10984", D: "95", C: "J64" },
              S: { S: "Q1065", H: "983", D: "AK62", C: "K2" },
              W: { S: "97", H: "A752", D: "J1084", C: "Q10987" }
            },
            opening_bid: "1S",
            correct_first_bid: "3S",
            alternatives: [],
            teaching_point: "Jump raise shows invitational values in competition",
            optimal_contract: "4S by N"
          },
          {
            id: "D01", module: "DEFENSE", title: "RHO Opens 1‚ô£",
            dealer: "E", vul: "None", your_seat: "S",
            hands: {
              N: { S: "K1093", H: "Q73", D: "Q852", C: "K4" },
              E: { S: "82", H: "A65", D: "AKJ1094", C: "Q5" },
              S: { S: "AQ65", H: "KJ84", D: "6", C: "A732" },
              W: { S: "J74", H: "1092", D: "73", C: "J10986" }
            },
            opening_bid: "1D",
            correct_first_bid: "X",
            alternatives: [],
            teaching_point: "Takeout double shows support for unbid suits",
            optimal_contract: "2S by S"
          },
          {
            id: "D02", module: "DEFENSE", title: "After RHO Opens 1‚ô¶",
            dealer: "W", vul: "None", your_seat: "S",
            hands: {
              N: { S: "1084", H: "Q73", D: "9852", C: "K64" },
              E: { S: "J9752", H: "1052", D: "J3", C: "Q85" },
              S: { S: "AQ6", H: "KJ8", D: "AK64", C: "A73" },
              W: { S: "K3", H: "A964", D: "Q107", C: "J1092" }
            },
            opening_bid: "1S",
            correct_first_bid: "1NT",
            alternatives: [],
            teaching_point: "1NT overcall shows 15-18 with stopper",
            optimal_contract: "3NT by S"
          },
          {
            id: "D03", module: "DEFENSE", title: "After RHO Opens 1‚ô£",
            dealer: "N", vul: "E/W", your_seat: "E",
            hands: {
              N: { S: "AQ64", H: "A6", D: "AK1094", C: "K3" },
              E: { S: "32", H: "KQJ10985", D: "J8", C: "94" },
              S: { S: "K1095", H: "32", D: "Q65", C: "AQ76" },
              W: { S: "J87", H: "74", D: "732", C: "J10852" }
            },
            opening_bid: "1D",
            correct_first_bid: "3H",
            alternatives: ["2H"],
            teaching_point: "Weak jump overcall shows long suit, preemptive",
            optimal_contract: "5D by N"
          },
          {
            id: "D04", module: "DEFENSE", title: "After Partner Doubles",
            dealer: "W", vul: "None", your_seat: "S",
            hands: {
              N: { S: "K1093", H: "A73", D: "KQ52", C: "K4" },
              E: { S: "82", H: "65", D: "AJ1094", C: "Q1085" },
              S: { S: "AQ65", H: "QJ84", D: "6", C: "A732" },
              W: { S: "J74", H: "K1092", D: "873", C: "J96" }
            },
            opening_bid: "1D",
            correct_first_bid: "X",
            alternatives: [],
            teaching_point: "Responsive double shows cards without clear major",
            optimal_contract: "4S by S"
          },
          {
            id: "D05", module: "DEFENSE", title: "In Passout Seat",
            dealer: "E", vul: "None", your_seat: "S",
            hands: {
              N: { S: "K1093", H: "KJ74", D: "Q52", C: "K4" },
              E: { S: "82", H: "65", D: "AKJ94", C: "Q1085" },
              S: { S: "AQ65", H: "QJ8", D: "A64", C: "732" },
              W: { S: "J74", H: "A10932", D: "1083", C: "AJ96" }
            },
            opening_bid: "Pass",
            correct_first_bid: "X",
            alternatives: ["1NT"],
            teaching_point: "Reopen in passout seat to protect partner",
            optimal_contract: "2S by S"
          }
        ];

        const BID_OPTIONS = [
          { label: 'Pass', value: 'Pass', color: 'gray' },
          { label: 'X', value: 'X', color: 'double' },
          { label: '1‚ô£', value: '1C', color: 'club' },
          { label: '1‚ô¶', value: '1D', color: 'diamond' },
          { label: '1‚ô•', value: '1H', color: 'heart' },
          { label: '1‚ô†', value: '1S', color: 'spade' },
          { label: '1NT', value: '1NT', color: 'nt' },
          { label: '2‚ô£', value: '2C', color: 'club' },
          { label: '2‚ô¶', value: '2D', color: 'diamond' },
          { label: '2‚ô•', value: '2H', color: 'heart' },
          { label: '2‚ô†', value: '2S', color: 'spade' },
          { label: '2NT', value: '2NT', color: 'nt' },
          { label: '3‚ô£', value: '3C', color: 'club' },
          { label: '3‚ô¶', value: '3D', color: 'diamond' },
          { label: '3‚ô•', value: '3H', color: 'heart' },
          { label: '3‚ô†', value: '3S', color: 'spade' },
          { label: '3NT', value: '3NT', color: 'nt' },
          { label: '4‚ô£', value: '4C', color: 'club' },
          { label: '4‚ô¶', value: '4D', color: 'diamond' },
          { label: '4‚ô•', value: '4H', color: 'heart' },
          { label: '4‚ô†', value: '4S', color: 'spade' },
          { label: '4NT', value: '4NT', color: 'nt' }
        ];

        // Main App
        const App = () => {
          const [view, setView] = useState('home');
          const [module, setModule] = useState('ALL');
          const [results, setResults] = useState([]);
          const [score, setScore] = useState(0);

          return (
            <div style={{
              minHeight: '100vh',
              background: 'linear-gradient(135deg, #0f1419 0%, #1a2332 100%)',
              color: '#e8edf2',
              padding: '40px 20px'
            }}>
              {view === 'home' && (
                <HomeScreen onStart={(m) => { setModule(m); setView('play'); }} />
              )}
              {view === 'play' && (
                <FullAuction 
                  module={module}
                  onComplete={(r, s) => { setResults(r); setScore(s); setView('summary'); }}
                  onHome={() => setView('home')}
                />
              )}
              {view === 'summary' && (
                <Summary results={results} score={score} onHome={() => setView('home')} />
              )}
            </div>
          );
        };

        const HomeScreen = ({ onStart }) => (
          <div style={{ maxWidth: '900px', margin: '0 auto', textAlign: 'center' }}>
            <h1 style={{
              fontFamily: "'Playfair Display', serif",
              fontSize: '64px',
              marginBottom: '16px',
              background: 'linear-gradient(135deg, #4ade80 0%, #22d3ee 100%)',
              WebkitBackgroundClip: 'text',
              WebkitTextFillColor: 'transparent'
            }}>
              SLAM Auction
            </h1>
            <p style={{ fontSize: '20px', color: '#94a3b8', marginBottom: '40px' }}>
              Full Interactive - Bid Multiple Times Throughout Auction
            </p>
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '20px' }}>
              {[
                { id: 'ALL', name: 'All Scenarios', color: '#60a5fa' },
                { id: 'BASIC', name: 'Basic Only', color: '#4ade80' }
              ].map(m => (
                <button key={m.id} onClick={() => onStart(m.id)} style={{
                  background: 'rgba(255, 255, 255, 0.03)',
                  border: `2px solid ${m.color}`,
                  borderRadius: '16px',
                  padding: '32px',
                  cursor: 'pointer',
                  fontSize: '24px',
                  fontWeight: '700',
                  color: m.color,
                  transition: 'all 0.2s'
                }}
                onMouseEnter={e => e.target.style.transform = 'translateY(-4px)'}
                onMouseLeave={e => e.target.style.transform = 'translateY(0)'}
                >
                  {m.name}
                </button>
              ))}
            </div>
            <div style={{
              marginTop: '40px',
              padding: '24px',
              background: 'rgba(255, 255, 255, 0.03)',
              borderRadius: '16px',
              textAlign: 'left'
            }}>
              <h3 style={{ marginBottom: '12px' }}>Scoring</h3>
              <div style={{ fontSize: '14px', color: '#94a3b8' }}>
                ‚Ä¢ 3 points: Best first bid<br/>
                ‚Ä¢ 2 points: Acceptable alternative<br/>
                ‚Ä¢ 0 points: Not recommended
              </div>
            </div>
          </div>
        );

        const Summary = ({ results, score, onHome }) => (
          <div style={{ maxWidth: '800px', margin: '0 auto', textAlign: 'center' }}>
            <h1 style={{ fontSize: '48px', marginBottom: '24px' }}>Session Complete!</h1>
            <div style={{
              fontSize: '72px',
              fontWeight: '700',
              color: '#4ade80',
              marginBottom: '32px'
            }}>
              {score}
            </div>
            <div style={{ marginBottom: '32px' }}>
              {results.map((r, i) => (
                <div key={i} style={{
                  padding: '16px',
                  background: 'rgba(255, 255, 255, 0.03)',
                  border: `1px solid ${r.points === 3 ? '#4ade80' : r.points === 2 ? '#fb923c' : '#f87171'}`,
                  borderRadius: '12px',
                  marginBottom: '12px',
                  display: 'flex',
                  justifyContent: 'space-between'
                }}>
                  <span>{r.title}: {formatBid(r.bid)}</span>
                  <span style={{ fontWeight: '700', color: r.points === 3 ? '#4ade80' : '#fb923c' }}>
                    +{r.points}
                  </span>
                </div>
              ))}
            </div>
            <div style={{ display: 'flex', gap: '16px', justifyContent: 'center' }}>
              <a 
                href="/"
                style={{
                  background: 'rgba(255, 255, 255, 0.05)',
                  color: '#94a3b8',
                  border: '1px solid rgba(255, 255, 255, 0.1)',
                  borderRadius: '12px',
                  padding: '16px 32px',
                  fontSize: '16px',
                  fontWeight: '600',
                  cursor: 'pointer',
                  textDecoration: 'none',
                  display: 'inline-block'
                }}
              >
                ‚åÇ Main Menu
              </a>
              <button onClick={onHome} style={{
                background: 'linear-gradient(135deg, #4ade80 0%, #22d3ee 100%)',
                color: '#0f1419',
                border: 'none',
                borderRadius: '12px',
                padding: '16px 32px',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer'
              }}>
                Play Again
              </button>
            </div>
          </div>
        );

        // FULL AUCTION COMPONENT - The main feature
        const FullAuction = ({ module, onComplete, onHome }) => {
          const scenarios = module === 'ALL' ? SCENARIOS : SCENARIOS.filter(s => s.module === module);
          const [idx, setIdx] = useState(0);
          const [results, setResults] = useState([]);
          const [totalScore, setTotalScore] = useState(0);
          
          const [auction, setAuction] = useState([]);
          const [currentSeat, setCurrentSeat] = useState(null);
          const [thinking, setThinking] = useState(false);
          const [complete, setComplete] = useState(false);
          const [userFirstBid, setUserFirstBid] = useState(null);
          const [showHints, setShowHints] = useState(false); // Changed to false by default
          const [showThinking, setShowThinking] = useState(false); // NEW: Show AI reasoning toggle
          
          const scen = scenarios[idx];

          // Initialize auction on scenario change
          useEffect(() => {
            if (scen) {
              const opening = { seat: scen.dealer, bid: scen.opening_bid, reasoning: 'Opening' };
              setAuction([opening]);
              setCurrentSeat(getNextSeat(scen.dealer));
              setComplete(false);
              setUserFirstBid(null);
            }
          }, [idx, scen]);

          // Check if auction is complete (3 consecutive passes)
          const isAuctionComplete = (bids) => {
            if (bids.length < 4) return false;
            return bids.slice(-3).every(b => b.bid === 'Pass');
          };

          // Get Claude to bid
          const getClaudeBid = async (seat) => {
            setThinking(true);
            try {
              // Define partnerships
              const partnerships = {
                'N': { partner: 'S', opponents: ['E', 'W'] },
                'E': { partner: 'W', opponents: ['N', 'S'] },
                'S': { partner: 'N', opponents: ['E', 'W'] },
                'W': { partner: 'E', opponents: ['N', 'S'] }
              };
              const partnership = partnerships[seat];
              
              // Format auction with partnership context
              const formatAuctionWithContext = (auction) => {
                return auction.map(b => {
                  const isYou = b.seat === seat;
                  const isPartner = b.seat === partnership.partner;
                  const label = isYou ? '‚òÖ YOU' : 
                               isPartner ? '‚òÖ YOUR PARTNER' : 
                               '‚úó OPPONENT';
                  return `${b.seat} (${label}): ${b.bid}`;
                }).join('\n');
              };
              
              const auctionStr = auction.length > 0 ? formatAuctionWithContext(auction) : 'None yet';
              
              // Check if last bid was from partner or opponent
              const lastBid = auction.length > 0 ? auction[auction.length - 1] : null;
              const lastBidContext = lastBid ? 
                (lastBid.seat === seat ? 'YOU' : 
                 lastBid.seat === partnership.partner ? 'your PARTNER' : 
                 'your OPPONENT') : 'Nobody';
              
              const calculateHCP = (hand) => {
                const hcp = {'A': 4, 'K': 3, 'Q': 2, 'J': 1};
                let total = 0;
                Object.values(hand).forEach(suit => {
                  for (let card of suit) {
                    total += hcp[card] || 0;
                  }
                });
                return total;
              };
              
              // Convert "10" to "T" in suits for AI clarity (so it doesn't count as 2 cards)
              const formatSuitForAI = (suit) => suit.replace(/10/g, 'T');
              
              const handHCP = calculateHCP(scen.hands[seat]);
              
              const prompt = `You are ${seat} playing bridge.

=== PARTNERSHIPS ===
YOUR PARTNER IS: ${partnership.partner}
YOU (${seat}) + ${partnership.partner} = PARTNERS working together
YOUR OPPONENTS ARE: ${partnership.opponents[0]} and ${partnership.opponents[1]}
${partnership.opponents[0]} + ${partnership.opponents[1]} = OPPONENTS trying to beat you

Your hand (${seat}):
Spades: ${formatSuitForAI(scen.hands[seat].S)} (${scen.hands[seat].S.length} cards)
Hearts: ${formatSuitForAI(scen.hands[seat].H)} (${scen.hands[seat].H.length} cards)
Diamonds: ${formatSuitForAI(scen.hands[seat].D)} (${scen.hands[seat].D.length} cards)
Clubs: ${formatSuitForAI(scen.hands[seat].C)} (${scen.hands[seat].C.length} cards)
Total HCP: ${handHCP}

IMPORTANT: These are YOUR ONLY cards. You do not have any other cards. Do not claim to have cards you don't have.
Note: "T" represents the 10 card (ten), not two separate cards.

The auction so far:
${auctionStr}

Last bid was from: ${lastBidContext} (${lastBid?.seat || 'N/A'} bid ${lastBid?.bid || 'N/A'})

${lastBid?.bid === '2C' && lastBidContext.includes('OPPONENT') ? 
`IMPORTANT: The 2‚ô£ bid was from an OPPONENT, not your partner! 
Do NOT respond to it as if it were Stayman from your partner.
You should either pass, overcall naturally, or double - NOT respond with 2‚ô¶/2‚ô•/2‚ô†!` : ''}

What should you bid next?

KEY RULES:
${scen.conventions?.includes('stayman') ? `- STAYMAN CONVENTION (for the 1NT opener ONLY):
  * If YOU opened 1NT and YOUR PARTNER bids 2‚ô£: You MUST ALWAYS show your 4-card major or deny having one
  * Look at YOUR OWN HAND:
    - If you have 4+ HEARTS: bid 2‚ô• (example: with H:KQ84, bid 2‚ô•)
    - If you have 4+ SPADES: bid 2‚ô† (example: with S:AJ73, bid 2‚ô†)
    - If you have BOTH 4+ hearts AND 4+ spades: bid 2‚ô• first
    - If you have NEITHER 4 hearts NOR 4 spades: bid 2‚ô¶ (denial)
  * If opponent overcalls 3‚ô£: bid 3‚ô• (with hearts) or 3‚ô† (with spades) or 3‚ô¶ (no major)
  * Answer at the CHEAPEST level above opponent's bid
  * CRITICAL: You MUST answer Stayman EVEN IF opponent doubles! The double does NOT cancel your obligation!
  * DO NOT PASS just because opponent doubled - you MUST still show your major or bid 2‚ô¶!
  * Passing is WRONG when partner bids Stayman - you MUST respond!
  * If you are NOT the 1NT opener: Do not respond to opponent's 2‚ô£ - that's between them and their partner!
` : ''}${scen.conventions?.includes('transfers') ? `- JACOBY TRANSFERS (for the 1NT opener ONLY):
  * If YOU opened 1NT and YOUR PARTNER bids 2‚ô¶: This is a TRANSFER to hearts - you MUST bid 2‚ô•
  * If YOU opened 1NT and YOUR PARTNER bids 2‚ô•: This is a TRANSFER to spades - you MUST bid 2‚ô†
  * If you are NOT the 1NT opener: Do not respond to opponent's transfers - that's between them and their partner!
` : ''}- When an OPPONENT bids anything: You may pass, overcall, or double
- Your bid must be higher than the last bid (unless you Pass or Double)
- Suit order: ‚ô£ < ‚ô¶ < ‚ô• < ‚ô† < NT

Respond with ONLY valid JSON:
{"bid": "Pass", "reasoning": "Brief explanation"}

Valid bid formats: Pass, X, 1C, 1D, 1H, 1S, 1NT, 2C, 2D, 2H, 2S, 2NT, ... up to 7NT`;

              const res = await fetch("/api/bid", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt })
              });

              if (!res.ok) throw new Error('API error');
              const data = await res.json();
              const text = data.content.find(c => c.type === 'text')?.text || '';
              
              // Clean and extract JSON more robustly
              let clean = text.trim();
              clean = clean.replace(/```json\s*/g, '').replace(/```\s*/g, '');
              
              // Try to extract JSON object if embedded in other text
              const jsonMatch = clean.match(/\{[^{}]*"bid"[^{}]*"reasoning"[^{}]*\}/);
              if (jsonMatch) {
                clean = jsonMatch[0];
              }
              
              console.log('Attempting to parse:', clean.substring(0, 100));
              const result = JSON.parse(clean);
              
              // Sanitize bid format (convert symbols/words to standard format)
              if (result.bid) {
                // Handle double variations
                if (result.bid.toUpperCase() === 'DOUBLE' || 
                    result.bid.toUpperCase() === 'DBL' || 
                    result.bid.toUpperCase() === 'D') {
                  result.bid = 'X';
                }
                // Handle redouble variations  
                else if (result.bid.toUpperCase() === 'REDOUBLE' || 
                         result.bid.toUpperCase() === 'RDBL' || 
                         result.bid.toUpperCase() === 'XX') {
                  result.bid = 'XX';
                }
                // Convert suit symbols to letters
                else if (result.bid !== 'Pass' && result.bid !== 'X' && result.bid !== 'XX') {
                  result.bid = result.bid
                    .replace(/‚ô£/g, 'C')
                    .replace(/‚ô¶/g, 'D')
                    .replace(/‚ô•/g, 'H')
                    .replace(/‚ô†/g, 'S')
                    .toUpperCase();
                }
              }
              
              setThinking(false);
              return result;
            } catch (err) {
              console.error('Claude bid error:', err);
              setThinking(false);
              return { bid: 'Pass', reasoning: 'Error' };
            }
          };

          // Add bid to auction
          const addBid = (bid, reasoning) => {
            const newAuction = [...auction, { seat: currentSeat, bid, reasoning }];
            setAuction(newAuction);
            
            if (isAuctionComplete(newAuction)) {
              setComplete(true);
              scoreScenario();
            } else {
              setCurrentSeat(getNextSeat(currentSeat));
            }
          };

          // User bids
          const handleUserBid = (bid) => {
            if (!userFirstBid) setUserFirstBid(bid);
            addBid(bid, 'Your bid');
          };

          // Score based on first bid
          const scoreScenario = () => {
            if (!userFirstBid) return;
            
            let points = 0;
            if (userFirstBid === scen.correct_first_bid) points = 3;
            else if (scen.alternatives.includes(userFirstBid)) points = 2;
            
            setTotalScore(totalScore + points);
            setResults([...results, {
              scenario: scen.id,
              title: scen.title,
              bid: userFirstBid,
              points
            }]);
          };

          // Auto-bid for other players
          useEffect(() => {
            if (!complete && currentSeat !== scen.your_seat && !thinking && currentSeat) {
              getClaudeBid(currentSeat).then(result => {
                // Log what AI returned
                console.log(`AI (${currentSeat}) returned:`, JSON.stringify(result));
                console.log(`Bid: "${result.bid}", Type: ${typeof result.bid}`);
                
                // Validate AI bid is legal
                const isLegal = result.bid === 'Pass' || result.bid === 'X' || isBidLegal(result.bid);
                console.log(`Is legal? ${isLegal}`);
                
                if (!isLegal) {
                  console.warn(`AI bid ${result.bid} is ILLEGAL, forcing Pass`);
                  console.log(`Last contract bid in auction:`, auction.slice().reverse().find(b => b.bid !== 'Pass' && b.bid !== 'X' && b.bid !== 'XX'));
                  addBid('Pass', 'Forced pass (illegal bid)');
                } else {
                  addBid(result.bid, result.reasoning);
                }
              });
            }
          }, [currentSeat, complete]);

          // Next scenario
          const handleNext = () => {
            if (idx < scenarios.length - 1) {
              setIdx(idx + 1);
            } else {
              onComplete(results, totalScore);
            }
          };

          // Check if bid is legal
          const isBidLegal = (bidValue) => {
            // Pass, double, redouble are always legal
            if (bidValue === 'Pass' || bidValue === 'X' || bidValue === 'XX') return true;
            
            // Find last contract bid (ignore Pass/X/XX)
            const lastBid = auction.slice().reverse().find(b => b.bid !== 'Pass' && b.bid !== 'X' && b.bid !== 'XX');
            if (!lastBid) return true; // First bid is always legal
            
            const getBidValue = (b) => {
              const level = parseInt(b.charAt(0));
              const suitOrder = { 'C': 0, 'D': 1, 'H': 2, 'S': 3, 'NT': 4 };
              return level * 5 + (suitOrder[b.substring(1)] || 0);
            };
            
            return getBidValue(bidValue) > getBidValue(lastBid.bid);
          };

          const isYourTurn = currentSeat === scen.your_seat && !complete;

          return (
            <div className="main-container">
              <div style={{ marginBottom: '32px' }}>
                <div className="header-row" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                  <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                    <a href="/" style={{
                      color: '#94a3b8',
                      textDecoration: 'none',
                      fontSize: '14px',
                      cursor: 'pointer'
                    }}>
                      ‚åÇ Main Menu
                    </a>
                    <span style={{ color: '#475569' }}>|</span>
                    <a href="/conventions" style={{
                      color: '#94a3b8',
                      textDecoration: 'none',
                      fontSize: '14px',
                      cursor: 'pointer'
                    }}>
                      üìñ Conventions
                    </a>
                    <h2 className="header-title" style={{ fontSize: '28px', margin: 0 }}>{scen.title}</h2>
                  </div>
                  <div style={{ display: 'flex', gap: '12px' }}>
                    <button 
                      onClick={() => setShowHints(!showHints)}
                      style={{
                        background: showHints ? 'rgba(34, 211, 238, 0.2)' : 'rgba(255, 255, 255, 0.05)',
                        border: `1px solid ${showHints ? 'rgba(34, 211, 238, 0.4)' : 'rgba(255, 255, 255, 0.1)'}`,
                        borderRadius: '8px',
                        padding: '8px 16px',
                        color: showHints ? '#22d3ee' : '#94a3b8',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                      }}
                    >
                      üí° {showHints ? 'Hints On' : 'Hints Off'}
                    </button>
                    <button 
                      onClick={() => setShowThinking(!showThinking)}
                      style={{
                        background: showThinking ? 'rgba(251, 146, 60, 0.2)' : 'rgba(255, 255, 255, 0.05)',
                        border: `1px solid ${showThinking ? 'rgba(251, 146, 60, 0.4)' : 'rgba(255, 255, 255, 0.1)'}`,
                        borderRadius: '8px',
                        padding: '8px 16px',
                        color: showThinking ? '#fb923c' : '#94a3b8',
                        fontSize: '14px',
                        fontWeight: '600',
                        cursor: 'pointer',
                        transition: 'all 0.2s'
                      }}
                    >
                      üß† {showThinking ? 'Thinking On' : 'Thinking Off'}
                    </button>
                  </div>
                </div>
                <div style={{ fontSize: '16px', color: '#94a3b8', textAlign: 'center' }}>
                  Scenario {idx + 1}/{scenarios.length} ‚Ä¢ Score: {totalScore}
                </div>
              </div>

              <div className="two-column-grid" style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px' }}>
                {/* Your Hand */}
                <div style={{
                  background: 'rgba(255, 255, 255, 0.03)',
                  border: '1px solid rgba(255, 255, 255, 0.08)',
                  borderRadius: '16px',
                  padding: '24px'
                }}>
                  <h3 style={{ marginBottom: '16px' }}>Your Hand ({scen.your_seat})</h3>
                  <HandDisplay hand={scen.hands[scen.your_seat]} />
                  {showHints && (
                    <div style={{
                      marginTop: '20px',
                      padding: '16px',
                      background: 'rgba(34, 211, 238, 0.1)',
                      borderRadius: '8px',
                      fontSize: '14px',
                      color: '#22d3ee'
                    }}>
                      üí° {scen.teaching_point}
                    </div>
                  )}
                </div>

                {/* Auction */}
                <div style={{
                  background: 'rgba(255, 255, 255, 0.03)',
                  border: '1px solid rgba(255, 255, 255, 0.08)',
                  borderRadius: '16px',
                  padding: '24px'
                }}>
                  <h3 style={{ marginBottom: '16px' }}>
                    Auction {complete && '(Complete)'}
                  </h3>
                  
                  <div style={{ display: 'flex', flexDirection: 'column', gap: '8px', marginBottom: '20px' }}>
                    {auction.map((b, i) => (
                      <div key={i} style={{
                        padding: '12px',
                        background: b.seat === scen.your_seat ? 'rgba(74, 222, 128, 0.1)' : 'rgba(255, 255, 255, 0.05)',
                        border: `1px solid ${b.seat === scen.your_seat ? 'rgba(74, 222, 128, 0.3)' : 'rgba(255, 255, 255, 0.1)'}`,
                        borderRadius: '8px',
                        display: 'flex',
                        gap: '12px'
                      }}>
                        <div style={{ fontWeight: '700', minWidth: '24px', color: '#94a3b8' }}>
                          {b.seat}
                        </div>
                        <div style={{ fontSize: '20px', fontWeight: '700', minWidth: '60px' }}>
                          {formatBid(b.bid)}
                        </div>
                        {showThinking && b.reasoning && (
                          <div style={{ fontSize: '13px', color: '#94a3b8', fontStyle: 'italic' }}>
                            {b.reasoning}
                          </div>
                        )}
                      </div>
                    ))}
                    
                    {thinking && (
                      <div style={{
                        padding: '16px',
                        background: 'rgba(34, 211, 238, 0.1)',
                        borderRadius: '8px',
                        textAlign: 'center',
                        color: '#22d3ee'
                      }}>
                        ü§î {currentSeat} is thinking...
                      </div>
                    )}
                  </div>

                  {complete && (
                    <div>
                      <div style={{
                        padding: '16px',
                        background: 'rgba(74, 222, 128, 0.1)',
                        borderRadius: '8px',
                        marginBottom: '16px'
                      }}>
                        <div style={{ fontSize: '12px', color: '#94a3b8' }}>FINAL CONTRACT</div>
                        <div style={{ fontSize: '24px', fontWeight: '700', color: '#4ade80' }}>
                          {(() => {
                            // Find last contract bid (not Pass/X/XX)
                            const lastContract = auction.slice().reverse().find(b => b.bid !== 'Pass' && b.bid !== 'X' && b.bid !== 'XX');
                            if (!lastContract) return 'Passed Out';
                            
                            // Determine declarer: first person in winning partnership to bid this strain
                            const strain = lastContract.bid.substring(1); // Get suit (C/D/H/S/NT)
                            const declarerSeat = lastContract.seat;
                            
                            // Get partner of declarer seat
                            const partnerships = { 'N': 'S', 'S': 'N', 'E': 'W', 'W': 'E' };
                            const partner = partnerships[declarerSeat];
                            
                            // Find first person in this partnership to bid this strain
                            let actualDeclarer = declarerSeat;
                            for (let i = 0; i < auction.length; i++) {
                              const bid = auction[i];
                              if (bid.bid !== 'Pass' && bid.bid !== 'X' && bid.bid !== 'XX') {
                                const bidStrain = bid.bid.substring(1);
                                if (bidStrain === strain && (bid.seat === declarerSeat || bid.seat === partner)) {
                                  actualDeclarer = bid.seat;
                                  break;
                                }
                              }
                            }
                            
                            // Check for doubles/redoubles
                            const hasDouble = auction.slice(auction.indexOf(lastContract)).some(b => b.bid === 'X');
                            const hasRedouble = auction.slice(auction.indexOf(lastContract)).some(b => b.bid === 'XX');
                            const modifier = hasRedouble ? ' Redoubled' : hasDouble ? ' Doubled' : '';
                            
                            return `${formatBid(lastContract.bid)}${modifier} by ${actualDeclarer}`;
                          })()}
                        </div>
                        <div style={{ fontSize: '14px', color: '#cbd5e1', marginTop: '8px' }}>
                          Optimal: {scen.optimal_contract}
                        </div>
                      </div>
                      <button onClick={handleNext} style={{
                        width: '100%',
                        background: 'linear-gradient(135deg, #4ade80 0%, #22d3ee 100%)',
                        color: '#0f1419',
                        border: 'none',
                        borderRadius: '12px',
                        padding: '14px',
                        fontSize: '16px',
                        fontWeight: '600',
                        cursor: 'pointer'
                      }}>
                        {idx < scenarios.length - 1 ? 'Next Scenario ‚Üí' : 'View Summary'}
                      </button>
                    </div>
                  )}
                </div>
              </div>

              {/* Bidding Interface */}
              {isYourTurn && !thinking && (
                <div style={{
                  marginTop: '24px',
                  background: 'rgba(255, 255, 255, 0.03)',
                  borderRadius: '16px',
                  padding: '24px'
                }}>
                  <h3 style={{ marginBottom: '20px', textAlign: 'center' }}>
                    Your Turn - What's your bid?
                  </h3>
                  <div className="bid-grid" style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fill, minmax(70px, 1fr))',
                    gap: '8px'
                  }}>
                    {BID_OPTIONS.map(bid => (
                      <BidButton
                        key={bid.value}
                        bid={bid}
                        onClick={() => handleUserBid(bid.value)}
                        disabled={!isBidLegal(bid.value)}
                      />
                    ))}
                  </div>
                </div>
              )}
            </div>
          );
        };

        // HandDisplay Component
        const HandDisplay = ({ hand }) => {
          const suits = [
            { symbol: '‚ô†', name: 'S', color: '#e2e8f0', bgColor: 'rgba(15, 20, 25, 0.4)', holding: hand.S },
            { symbol: '‚ô•', name: 'H', color: '#f87171', bgColor: 'rgba(248, 113, 113, 0.1)', holding: hand.H },
            { symbol: '‚ô¶', name: 'D', color: '#fb923c', bgColor: 'rgba(251, 146, 60, 0.1)', holding: hand.D },
            { symbol: '‚ô£', name: 'C', color: '#4ade80', bgColor: 'rgba(74, 222, 128, 0.1)', holding: hand.C }
          ];

          return (
            <div style={{ display: 'flex', flexDirection: 'column', gap: '10px' }}>
              {suits.map(suit => (
                <div key={suit.name} style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                  <div style={{
                    width: '32px',
                    height: '32px',
                    borderRadius: '6px',
                    background: suit.bgColor,
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    fontSize: '20px',
                    color: suit.color,
                    fontWeight: '700'
                  }}>
                    {suit.symbol}
                  </div>
                  <div style={{ fontSize: '18px', fontWeight: '600', letterSpacing: '0.08em' }}>
                    {suit.holding}
                  </div>
                </div>
              ))}
            </div>
          );
        };

        // BidButton Component
        const BidButton = ({ bid, onClick, disabled = false }) => {
          const [hover, setHover] = useState(false);

          const getColors = (color) => {
            const schemes = {
              gray: { bg: 'rgba(148, 163, 184, 0.1)', border: 'rgba(148, 163, 184, 0.3)', text: '#cbd5e1' },
              club: { bg: 'rgba(22, 101, 52, 0.2)', border: 'rgba(74, 222, 128, 0.4)', text: '#4ade80' },
              diamond: { bg: 'rgba(234, 88, 12, 0.2)', border: 'rgba(251, 146, 60, 0.4)', text: '#fb923c' },
              heart: { bg: 'rgba(220, 38, 38, 0.2)', border: 'rgba(248, 113, 113, 0.4)', text: '#f87171' },
              spade: { bg: 'rgba(15, 20, 25, 0.4)', border: 'rgba(226, 232, 240, 0.4)', text: '#e2e8f0' },
              nt: { bg: 'rgba(59, 130, 246, 0.2)', border: 'rgba(96, 165, 250, 0.4)', text: '#60a5fa' },
              double: { bg: 'rgba(251, 146, 60, 0.2)', border: 'rgba(251, 146, 60, 0.4)', text: '#fb923c' }
            };
            return schemes[color] || schemes.gray;
          };

          const colors = getColors(bid.color);

          return (
            <button
              onClick={disabled ? null : onClick}
              onMouseEnter={() => !disabled && setHover(true)}
              onMouseLeave={() => setHover(false)}
              disabled={disabled}
              style={{
                background: disabled ? 'rgba(255, 255, 255, 0.02)' : hover ? colors.bg : 'rgba(255, 255, 255, 0.05)',
                border: `2px solid ${disabled ? 'rgba(255, 255, 255, 0.05)' : hover ? colors.border : 'rgba(255, 255, 255, 0.1)'}`,
                borderRadius: '8px',
                padding: '12px 8px',
                color: disabled ? 'rgba(255, 255, 255, 0.2)' : colors.text,
                fontSize: '16px',
                fontWeight: '600',
                cursor: disabled ? 'not-allowed' : 'pointer',
                transition: 'all 0.2s',
                opacity: disabled ? 0.3 : 1,
                transform: hover && !disabled ? 'translateY(-2px)' : 'translateY(0)',
                boxShadow: hover && !disabled ? `0 4px 12px ${colors.border}` : 'none'
              }}
            >
              {bid.label}
            </button>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    
    <!-- Footer -->
    <footer style="position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; padding: 1rem; text-align: center; border-top: 1px solid #334155; z-index: 1000;">
        <a href="https://github.com/todd427/slam-auction-interactive/issues/new" target="_blank" style="color: #94a3b8; text-decoration: none; margin: 0 1rem;">Report Bug üêõ</a>
        <span style="color: #475569;">|</span>
        <a href="/cdn-cgi/l/email-protection#e88e8d8d8c8a898b83a89b8489858a9a818c8f8dc6818d" style="color: #94a3b8; text-decoration: none; margin: 0 1rem;">Feedb